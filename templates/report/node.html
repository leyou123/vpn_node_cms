{% extends "admin/base_site.html" %}
{% load i18n static %}
{% load static %}

{% block content %}
    <script type="text/javascript" src="{% static 'report/js/jquery.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'report/js/moment.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'report/js/zh-cn.js' %}"></script>
    <script type="text/javascript" src="{% static 'report/js/daterangepicker.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'report/js/jquery.dataTables.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'report/js/request.js' %}"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'report/css/daterangepicker.min.css' %}"/>
    <link rel="stylesheet" type="text/css" href="{% static 'report/css/bootstrap.min.css' %}"/>
    <link rel="stylesheet" type="text/css" href="{% static 'report/css/jquery.dataTables.min.css' %}"/>

{#　   <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>#}
{#    <script>#}
{#    $(".breadcrumbs").append("&nbsp;&nbsp;<a href=\"/admin/\">仪表盘</a>");#}
{#    $(".breadcrumbs").append("&nbsp;&nbsp;<a href=\"/admin/\">主机监控</a>");#}
{#    $(".breadcrumbs").append("&nbsp;&nbsp;<a href=\"/admin/\">命令执行</a>");#}
{#    $(".breadcrumbs").append("&nbsp;&nbsp;<a href=\"/admin/\">图表绘制</a>");#}
{#    $(".breadcrumbs").append("&nbsp;&nbsp;<a href=\"/admin/\">批量CMD</a>");#}
{#    </script>#}

    <input name="dates" type="text" id="date_range">
    <input type="button" value="今天" id="today">
    <input type="button" value="昨天" id="yesterday">
    <input type="button" value="本周" id="week">
    <input type="button" value="上周" id="last_week">
    <input type="button" value="本月" id="month">
    <input type="button" value="上月" id="last_month">
    <select class="form-select" aria-label="Default select example" id="country">
        <option selected>国家</option>
        {% for item in countrys %}
            <option value="{{ item.country }}">{{ item.country }}</option>
        {% endfor %}
    </select>

    <table class="table table-striped" id="TBcountry">
        <thead>
            <tr id="theader">
                <th>国家</th>
                <th>ping成功率</th>
                <th>连接成功率</th>
                <th>日期</th>
            </tr>
        </thead>
        <tbody id="tbody_country">

        {% if results %}
            {% for item in results %}
                <tr>
                    <td>{{ item.country }}</td>
                    <td>{% if item.ping_total > 0 %} {% widthratio item.ping_failed_total item.ping_total 1 %}% {% endif %}</td>
                    <td>{{ item.connect_rate }}{% if item.connect_rate %}%{% endif %}</td>
                </tr>
            {% endfor %}
        {% endif %}
        </tbody>
    </table>

    <nav aria-label="Page navigation">
      <ul class="pagination">
          {{ page_info.pager|safe }}
      </ul>
    </nav>

    <script>
        let _ajax = new Request();
        var tbodyHTML = "";
        var countryHTML = "";
        let updateCountry = function (data) {
            $("#tbody_country").html("");
            for (var i = 0; i < data.results.length; i++) {
                for (var j = 0; j < data.results[i].connect_list.length; j++) {
                    var connect_rate = 0;
                    var ping_rate = 0;
                    var item = data.results[i].connect_list[j];
                    console.log(item);
                    if (item.country == "") continue;
                    if (item.connect_total + item.connect_failed_total > 0) connect_rate = item.connect_failed_total / (item.connect_total + item.connect_failed_total) * 100;
                    if (item.ping_total = item.ping_failed_total > 0) ping_rate = item.ping_failed_total / (item.ping_total + item.ping_failed_total) * 100;
                    var html = "<tr class='country_row'>\n" +
                        "                    <td>"+ item.country +"</td>\n" +
                        "                    <td>"+ ping_rate.toFixed(2) +"%</td>\n" +
                        "                    <td>"+ connect_rate.toFixed(2) +"%</td>\n" +
                        "                    <td>"+ data.results[i].date +"</td>\n" +
                        "                </tr>";
                    $("#tbody_country").append(html);
                }
            }
            tbodyHTML = $("#tbody_country").html();
        };

        $(document).ready(function() {

            $('#TBcountry').DataTable({
                 "paging": false, // 禁止分页
            });


            $('input[name="dates"]').daterangepicker({
                opens:'left'
             }, function(start, end, label) {
                var data = {
                    "type":"range",
                    "start_date":start.format('YYYY-MM-DD'),
                    "end_date":end.format('YYYY-MM-DD'),
                };
                console.log("选择了一个新的日期: "+start.format('YYYY-MM-DD') +' to '+end.format('YYYY-MM-DD'));
                _ajax.post("http://54.177.55.54:7000/report/country",data, function(data, status) {
                    updateCountry(data);
                })
             });

            $("#today").click(function () {
                return;
                var data = {
                    "type":"today"
                };
                _ajax.post("http://54.177.55.54:7000/report/country",data, function(data, status) {
                    updateCountry(data);
                })
            });

            $("#country").change(function () {
                var country_name = $(this).val();
                if(country_name!=""){
                    $("table tr:not('#theader')").hide().filter(":contains('"+country_name+"')").show();
                } else if (country_name == "国家") {
                    $("table tr:not('#theader')").show();
                }
                else{
                    $("table tr:not('#theader')").show();
                }

            });

        });



    </script>
{% endblock %}