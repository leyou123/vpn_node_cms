{% extends "admin/base_site.html" %}
{% load i18n static %}
{% load static %}

{% block content %}
    <script type="text/javascript" src="{% static 'report/js/jquery.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'report/js/moment.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'report/js/zh-cn.js' %}"></script>
    <script type="text/javascript" src="{% static 'report/js/daterangepicker.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'report/js/jquery.dataTables.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'report/js/request.js' %}"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'report/css/daterangepicker.min.css' %}"/>
    <link rel="stylesheet" type="text/css" href="{% static 'report/css/bootstrap.min.css' %}"/>
    <link rel="stylesheet" type="text/css" href="{% static 'report/css/jquery.dataTables.min.css' %}"/>


    <input name="dates" type="text" id="date_range">
    <input type="button" value="今天" id="today">
    <input type="button" value="昨天" id="yesterday">
    <input type="button" value="本周" id="week">
    <input type="button" value="上周" id="last_week">
    <input type="button" value="本月" id="month">
    <input type="button" value="上月" id="last_month">
    <select class="form-select" aria-label="Default select example" id="country">
        <option selected>国家</option>
        {% for item in countrys %}
            <option value="{{ item.country }}">{{ item.country }}</option>
        {% endfor %}
    </select>

    <table class="table table-striped" id="TBcountry">
        <thead>
            <tr class="theader">
                <th>全部ping成功率</th>
                <th id="all_ping"></th>
                <th>全部连接成功率</th>
                <th id="all_connect"></th>
            </tr>
            <tr class="theader">
                <th>国家</th>
                <th>节点ip</th>
                <th>ping成功率</th>
                <th>连接成功率</th>
                <th>节点名称</th>
                <th>日期</th>
            </tr>

        </thead>
        <tbody id="tbody_country">

        {% if results %}
            {% for item in results %}
                <tr>
                    <td>{{ item.country }}</td>
                    <td>{% if item.ping_total > 0 %} {% widthratio item.ping_failed_total item.ping_total 1 %}% {% endif %}</td>
                    <td>{{ item.connect_rate }}{% if item.connect_rate %}%{% endif %}</td>
                </tr>
            {% endfor %}
        {% endif %}
        </tbody>
    </table>

    <nav aria-label="Page navigation">
      <ul class="pagination">
          {{ page_info.pager|safe }}
      </ul>
    </nav>

    <script>
        let _ajax = new Request();
        {#let base_url = "http://54.177.55.54:7000/";#}
        let base_url = "http://54.177.55.54:9000/";


        let updateCountry = function (data) {
            $("#tbody_country").html("");
            var all_country_ping_total = 0;
            var all_country_ping_failed_total = 0;
            var all_country_connect_total = 0;
            var all_country_connect_failed_total = 0;
            for (var i = 0; i < data.results.length; i++) {
                for (var j = 0; j < data.results[i].connect_list.length; j++) {
                    var connect_rate = 0;
                    var ping_rate = 0;
                    var item = data.results[i].connect_list[j];
                    if (item.country == "") continue;
                    if (item.connect_total + item.connect_failed_total > 0) {
                        connect_rate = item.connect_failed_total / (item.connect_total + item.connect_failed_total) * 100;
                        all_country_connect_total += item.connect_total + item.connect_failed_total;
                        all_country_connect_failed_total += item.connect_failed_total;
                    }
                    if (item.ping_total + item.ping_failed_total > 0) {
                        ping_rate = item.ping_failed_total / (item.ping_total + item.ping_failed_total) * 100;
                        all_country_ping_total += item.ping_total + item.ping_failed_total;
                        all_country_ping_failed_total += item.ping_total;
                    }
                    var html = "<tr class='country_row'>\n" +
                        "                    <td>"+ item.country +"</td>\n" +
                        "                    <td>"+ item.node_ip +"</td>\n" +
                        "                    <td>"+ ping_rate.toFixed(2) +"%</td>\n" +
                        "                    <td>"+ connect_rate.toFixed(2) +"%</td>\n" +
                        "                    <td>"+ item.node_name +"</td>\n" +
                        "                    <td>"+ data.results[i].date +"</td>\n" +
                        "                </tr>";
                    $("#tbody_country").append(html);
                }
            }
            var total_ping = all_country_ping_failed_total / all_country_ping_total * 100;
            var total_connect = all_country_connect_failed_total / all_country_connect_total * 100;
            $('#all_ping').text(total_ping.toFixed(2));
            $('#all_connect').text(total_connect.toFixed(2));

        };

        $(document).ready(function() {

            $('#TBcountry').DataTable({});


            $('input[name="dates"]').daterangepicker({
                opens:'left'
             }, function(start, end, label) {
                var data = {
                    "type":"range",
                    "start_date":start.format('YYYY-MM-DD'),
                    "end_date":end.format('YYYY-MM-DD'),
                };
                _ajax.post(base_url + "report/node",data, function(data, status) {
                    updateCountry(data);
                })
             });


            $("#country").change(function () {
                var country_name = $(this).val();
                if(country_name!=""){
                    $("table tr:not('.theader')").hide().filter(":contains('"+country_name+"')").show();
                } else if (country_name == "国家") {
                    $("table tr:not('.theader')").show();
                }
                else{
                    $("table tr:not('.theader')").show();
                }

            });

        });



    </script>
{% endblock %}