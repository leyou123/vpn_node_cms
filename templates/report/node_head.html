{% extends "admin/base_site.html" %}
{% load i18n static %}
{% load static %}

{% block content %}
    <script type="text/javascript" src="{% static 'report/js/jquery.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'report/js/moment.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'report/js/zh-cn.js' %}"></script>
    <script type="text/javascript" src="{% static 'report/js/daterangepicker.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'report/js/jquery.dataTables.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'report/js/request.js' %}"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'report/css/daterangepicker.min.css' %}"/>
    <link rel="stylesheet" type="text/css" href="{% static 'report/css/bootstrap.min.css' %}"/>
    <link rel="stylesheet" type="text/css" href="{% static 'report/css/jquery.dataTables.min.css' %}"/>


    <input name="dates" type="text" id="date_range">
    <input type="button" value="今天" id="today">
    <input type="button" value="昨天" id="yesterday">
    <input type="button" value="本周" id="week">
    <input type="button" value="上周" id="last_week">
    <input type="button" value="本月" id="month">
    <input type="button" value="上月" id="last_month">
    <select class="form-select" aria-label="Default select example" id="country">
        <option selected>国家</option>
        {% for item in countrys %}
            <option value="{{ item.country }}">{{ item.country }}</option>
        {% endfor %}
    </select>

    <table class="table table-striped" id="TBcountry">
        <thead>
            <tr class="theader">
                <th></th>
                <th></th>
                <th></th>
                <th id="all_ping"></th>
                <th id="all_connect"></th>
                <th></th>
            </tr>
            <tr class="theader">
                <th>国家</th>
                <th>节点名称</th>
                <th>节点IP</th>
                <th>ping总数</th>
                <th>连接总数</th>
                <th>日期</th>
            </tr>

        </thead>
        <tbody id="tbody_country">

        {% if results %}
            {% for item in results %}
                <tr>
                    <td>{{ item.country }}</td>
                    <td>{% if item.ping_total > 0 %} {% widthratio item.ping_failed_total item.ping_total 1 %}% {% endif %}</td>
                    <td>{{ item.connect_rate }}{% if item.connect_rate %}%{% endif %}</td>
                </tr>
            {% endfor %}
        {% endif %}
        </tbody>
    </table>

    <nav aria-label="Page navigation">
      <ul class="pagination">
          {{ page_info.pager|safe }}
      </ul>
    </nav>

    <script>
        let _ajax = new Request();
        let base_url = "http://54.177.55.54:7000/";
        {#let base_url = "http://54.177.55.54:9000/";#}


        let updateCountry = function (data) {
            $("#tbody_country").html("");
            var all_total_ping = 0;
            var all_total_connect = 0;
            for (var i = 0; i < data.results.length; i++) {
                for (var j = 0; j < data.results[i].connect_list.length; j++) {
                    var item = data.results[i].connect_list[j];
                    if (item.country == "") continue;
                    var html = "<tr class='country_row' ping_total='"+ item.ping_total +"' connect_total='"+ item.connect_total +"'>\n" +
                        "                    <td>"+ item.country +"</td>\n" +
                        "                    <td>"+ item.node_name +"</td>\n" +
                        "                    <td>"+ item.node_ip +"</td>\n" +
                        "                    <td>"+ item.ping_total +"</td>\n" +
                        "                    <td>"+ item.connect_total +"</td>\n" +
                        "                    <td>"+ data.results[i].date +"</td>\n" +
                        "                </tr>";
                    $("#tbody_country").append(html);
                    all_total_ping += item.ping_total;
                    all_total_connect += item.connect_total;
                }
            }

            $('#all_ping').text(all_total_ping);
            $('#all_connect').text(all_total_connect);

        };

        $(document).ready(function() {

            $('#TBcountry').DataTable({});


            $('input[name="dates"]').daterangepicker({
                opens:'left'
             }, function(start, end, label) {
                var data = {
                    "type":"range",
                    "start_date":start.format('YYYY-MM-DD'),
                    "end_date":end.format('YYYY-MM-DD'),
                };
                _ajax.post(base_url + "report/node_head",data, function(data, status) {
                    updateCountry(data);
                })
             });


            $("#country").change(function () {
                var country_name = $(this).val();
                if(country_name!=""){
                    {#$("table tr:not('.theader')").hide().filter(":contains('"+country_name+"')").show();#}
                    var total_ping = 0;
                    var total_connect = 0;
                    var trs = $("table tr:not('.theader')").hide().filter(":contains('"+country_name+"')");
                    trs.show();
                    for (var tr=0; tr < trs.length; tr++) {
                        total_ping += Number(trs.eq(tr).attr("ping_total"));
                        total_connect += Number(trs.eq(tr).attr("connect_total"));
                    }
                    $('#all_ping').text(total_ping);
                    $('#all_connect').text(total_connect);
                } else if (country_name == "国家") {
                    $("table tr:not('.theader')").show();
                }
                else{
                    $("table tr:not('.theader')").show();
                }

            });

        });


    </script>
{% endblock %}